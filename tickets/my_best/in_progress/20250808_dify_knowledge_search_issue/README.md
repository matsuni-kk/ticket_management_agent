---
file_type: "ticket_summary"
ticket_id: "TKT-20250808-001"
title: "Difyナレッジの検索精度低下/ヒットしない問題"
company: "マイベスト"
reporter: "Kyohei Katada (Kata Kyo)"
create_date: "2025-08-08"
update_date: "2025-08-08"
status: "解決済"
category: "技術的問題"
priority: "高"
assigned_to: "國松"
estimated_hours: "TBD"
final_resolution_date: "2025-08-08"
customer_confirmation: "対応完了確認済み"
issued_at: "2025-08-08"
due_date: ""
ball_holder: "クローズ"
---

## サマリー
Dify Cloud Pro (v1.7.1) のナレッジ検索で、インデックス済みのキーワードが全文/ベクトル/ハイブリッド検索でもヒットしない、または精度が著しく低下する事象。前日 Rerank オフではヒットしていたが、ナレッジ更新後に再びヒットしなくなった。

## 影響範囲
- マーケ部の 30,000 KW 運用フローに影響。日次 3,000 件の更新で反復発生。

## 現状と仮説
- 短文（KWのみ）のチャンクが大半。ベクトル検索の類似度が安定しづらい可能性。
- 埋め込みモデルの混在や再埋め込み未実施での不整合。
- フルテキストのトークナイズ/スコア閾値/上位件数(top_k)設定の影響。

## 当面の対応方針
1) スコア閾値をオフ、top_k を十分に上げて挙動を確認。
2) Embedding モデルを日本語に強いものへ切替→元に戻す（全量再埋め込み）で整合性回復を試験。
3) 短文データ向けのハイブリッド/全文最適化（N-gram/BM25パラメータ・同義語/正規化）を検討。
4) メタデータや同義語辞書導入、前処理による正規化（記号/大小/カナ/スペース）を適用。

## 次アクション
- 技術調査（設定項目の棚卸し・再埋め込み・小規模サンプルでのABテスト）
- 改善提案の提示と実装手順の共有

## 進捗更新（2025-08-08）
- スコア閾値オフでの検索: ヒットせず、または精度が著しく低いケースを確認（全文/ハイブリッド含む）。
- データ特性: チャンクはKWのみ、10〜15文字程度が中心で短文。
- 対処1: Embeddingモデルを一度切替→元に戻し、全量再埋め込みを実施。キッチンバサミ等、一部クエリで改善を確認。
- 残課題: 「空気清浄機」など一部で完全一致チャンクが存在してもnullになる事象を確認。インデックス側のエラー/不整合の可能性。
- 確認依頼: 同一ベクトルDB・同一ドキュメントでの事象か、ベクトルDBが複数あるかを確認中。

### 推奨追加アクション
1) ベクトルDB/インデックス状態の確認（Difyのナレッジ＞インデックス/ジョブログのステータス、失敗件数）。
2) 対象ナレッジを限定して「インデックス再構築（rebuild）」を実行。
3) 再構築後にスモールセット（例: 50KW）で再評価（ベクトル/全文/ハイブリッド、Rerank有無）。
4) 依然nullが出る場合は、該当KWのチャンクID/メタデータを抽出し、インデックス側の欠落・破損を切り分け。

## 解決策 (2025-08-08)

### 原因
ナレッジのインデックス作成時にエラーが発生しており、一部のキーワードが正しくインデックス化されていなかったことが根本原因。

### 解決までの経緯
1.  **初期調査**: 検索スコアの閾値やRerankモデルをオフにしても解決せず。
2.  **Embeddingモデルの再設定**: Embeddingモデルを一度別のものに切り替え、再度元に戻すことで全チャンクの再埋め込みをトリガー。これにより一部のキーワード（例：「キッチンバサミ」）で検索結果が改善。
3.  **残存課題**: しかし、「空気清浄機」など一部のキーワードでは依然としてヒットしない問題が継続。
4.  **原因特定と解決**: Difyのナレッジ管理画面で、インデックス作成ジョブにエラーが発生していることを確認。インデックスの再実行を行い、正常に完了したことで、すべてのキーワードで検索がヒットするようになり、問題は完全に解決した。

### 顧客からの確認
- **Kyohei Katada (2025-08-08 18:57)**: 「直りました！」
- → **解決確認済み**
