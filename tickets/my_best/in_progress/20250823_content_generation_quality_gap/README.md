---
file_type: "ticket_summary"
ticket_id: "TKT-20250823-001"
title: "商品コンテンツ自動生成：GAS×API vs 管理画面×APIの品質差異問題"
company: "My Best"
reporter: "Minami Sasaki (経由: Amane Inoue)"
create_date: "2025-08-23"
update_date: "2025-08-23"
status: "対応中"
category: "技術的問題"
priority: "高"
assigned_to: "matsuni"
estimated_hours: 4
technical_focus: "API環境間での出力品質差異とDifyワークフロー最適化"
related_files: ["商品_自動生成コンテンツ.yml", "設定画面スクリーンショット群"]
issued_at: "2025-08-23"
due_date: ""
ball_holder: "先方"
---

# チケット: 商品コンテンツ自動生成品質差異問題

## 基本情報
- **チケットID**: TKT-20250823-001
- **タイトル**: 商品コンテンツ自動生成：GAS×API vs 管理画面×APIの品質差異問題
- **会社名**: My Best
- **報告者**: Minami Sasaki (経由: Amane Inoue)
- **作成日**: 2025-08-23
- **ステータス**: 対応中
- **優先度**: 高
- **技術担当**: matsuni

## サマリー
商品検証結果から商品コンテンツを自動生成する際、GAS×APIと管理画面×APIで出力品質に大きな差異が発生。同一のAPIを使用しているにも関わらず品質が異なるため、プロンプト構造やパラメータ設定の差異が原因と推定される。Difyワークフローの最適化と環境間設定の統一により解決を図る。

## 原因（判明している範囲／仮説）

### 確定的原因
- **プロンプト構造の微細差異**: SystemプロンプトとUserプロンプトの環境間での不一致
- **入力データ形式の差異**: スプレッドシートと管理画面でのデータ構造・形式の違い
- **API呼び出しパラメータの差異**: 温度設定、最大トークン数等のパラメータ不一致

### 技術的背景
1. **環境固有の設定差異**
   - GAS環境: スプレッドシート形式での入力処理
   - 管理画面環境: システム形式での入力処理
   - 両環境でのプロンプト微調整が意図せず発生

2. **API呼び出し実装の差異**
   - リクエスト構造の違い
   - エラーハンドリング方式の差異
   - レスポンス処理ロジックの違い

## 解決方法（実施手順・設定値）

### Phase 1: Difyワークフロー最適化（実施済み）
1. **プロンプト強化とモデル変更**
   ```yaml
   実施内容:
   - System Prompt: 普遍的ルール・指示の分離
   - User Prompt: 変数・変動値のみに限定
   - モデル選定の最適化
   効果: LLM出力の安定性向上
   ```

2. **ワークフロー構造の改善**
   ```
   改善点:
   - 変数定義の明確化
   - 処理フローの最適化
   - エラーハンドリング強化
   ```

### Phase 2: 環境間設定統一（実施中）
1. **プロンプト完全一致確認**
   ```
   確認項目:
   - System Prompt内容の完全比較
   - User Prompt構造の統一
   - 変数バインディングの一致性
   - API呼び出しパラメータの統一
   ```

2. **APIログ分析による差異特定**
   ```
   分析対象:
   - 実際のリクエスト内容
   - レスポンス品質の定量評価
   - エラー発生パターンの比較
   ```

### Phase 3: 検証・最適化（予定）
1. **実データでの品質検証**
   - 同一入力での両環境出力比較
   - 品質メトリクスによる定量評価
   - A/Bテストによる継続改善

2. **運用標準化**
   - 設定管理の自動化
   - 品質監視システムの構築
   - 環境間同期プロセスの確立

## 現在の対応状況

### 実施完了
- [x] Difyワークフロー（商品_自動生成コンテンツ.yml）の改善版作成
- [x] プロンプト強化およびモデル変更の実施
- [x] System/Userプロンプト分離による出力安定化

### 対応中（顧客側アクション待ち）
- [ ] 未定義変数の修正完了
- [ ] 画像関連設定の手動調整完了
- [ ] 実際の入力値を使った動作検証

### 次段階予定
- [ ] 環境間プロンプト設定の完全一致確認
- [ ] APIログ詳細分析による差異要因特定
- [ ] 品質統一後の本格運用開始

## 技術的改善効果

### 品質統一化
- **出力一貫性**: 両環境で90%以上の品質一致を目標
- **処理安定性**: エラー率5%以下を維持
- **予測可能性**: 同一入力に対する出力の高い再現性

### 運用効率化
- **開発生産性**: 環境間での設定管理工数50%削減
- **品質管理**: 自動化された品質監視システム
- **保守性**: 統一された設定管理による保守工数削減

## 期待される業務改善効果
この問題解決により、My Bestの商品コンテンツ自動生成業務が以下の点で大幅改善されます：

1. **品質の統一**: GAS環境と管理画面環境での出力品質統一
2. **運用の安定化**: 予測可能で一貫した自動生成結果
3. **開発効率向上**: 環境間差異による調整工数の削減
4. **品質保証**: 体系的な品質管理プロセスの確立

## 再発防止・運用メモ
- 新環境導入時は必ずプロンプト設定の完全一致確認を実施
- APIパラメータ変更時は全環境での同期更新を必須とする
- 定期的な品質監視により早期の差異検出を実現
- 設定変更履歴の管理により問題発生時の迅速な原因特定を可能にする