---
file_type: "ticket_summary"
ticket_id: "TKT-20250820-002"
title: "Difyワークフローのコード→LLM変数入力不具合"
company: "My Best"
reporter: "Kaho Nagaso"
create_date: "2025-08-20"
update_date: "2025-08-22"
status: "対応中"
category: "技術的問題"
priority: "高"
assigned_to: "技術チーム"
estimated_hours: 4
problem_type: "ワークフロー内変数受け渡し不具合"
technical_focus: "コードノード→LLMノードの変数入力問題"
workflow_file: "★ランキング_スクリーニングくんver2.4 (4).yml"
screenshot_evidence: "2件のスクリーンショット提供済み"
issued_at: "2025-08-20"
due_date: ""
ball_holder: "先方"
---

# チケット: Difyワークフローのコード→LLM変数入力不具合

## 基本情報
- **チケットID**: TKT-20250820-002
- **タイトル**: Difyワークフローのコード→LLM変数入力不具合
- **会社名**: My Best
- **報告者**: Kaho Nagaso
- **作成日**: 2025-08-20
- **ステータス**: 新規
- **優先度**: 高
- **関連ファイル**: ★ランキング_スクリーニングくんver2.4 (4).yml + スクリーンショット2件

## サマリー
Difyワークフローにおいて、コードノードからLLMノードへの変数受け渡しが不安定に動作。コード側で出力変数を正しく指定しているにも関わらず、LLMノードに変数が入力されない現象が時々発生。業務の自動処理に影響を与える可能性があり、根本原因の分析と安定化対策が必要。

## 原因（判明している範囲／仮説）

### 確定的原因
- **Array「object」型の変数参照制限**: LLMノードで対象にできる変数にArray「object」が入っていないため参照できない
- **データ型の制限**: DifyのLLMノードは特定のデータ型（Array object）を直接参照できない仕様上の制限

### システム的要因
1. **Dify内部の変数管理**
   - ワークフロー実行時の変数管理機構の制約
   - ノード間データ受け渡しの内部実装問題
   - メモリ・状態管理の不安定性

2. **設定・構成上の問題**
   - 変数バインディングの設定ミス
   - ノード接続の論理的エラー
   - ワークフロー実行順序の問題

### 環境・条件依存の要因
- **実行環境**: 負荷状況や実行時間による影響
- **データサイズ**: 大量データ処理時の変数受け渡し制限
- **バージョン**: Difyのバージョン固有の不具合

## 解決方法（実施手順・設定値）

### 確定解決策：テンプレートノードを使用した型変換

**回避方法**: Array「object」型の変数を直接LLMノードに渡さず、「テンプレート」ノードを使って一度string型に変換してからLLMノードに渡す

#### 実装手順：
1. **コードノード → テンプレートノード → LLMノード** の流れに変更
2. **テンプレートノード設定**:
   ```
   入力: Array object型の変数
   処理: JSON.stringify()またはテンプレート記法でstring化
   出力: string型の変数
   ```
3. **LLMノードでstring型変数を参照**:
   ```
   入力変数: {{template_node_output}}
   ```

#### 具体的な設定例：
```yaml
テンプレートノード設定:
  input_variables: 
    - array_object_variable (from Code Node)
  template: |
    {{array_object_variable | json}}
  output_variable: stringified_data

LLMノード設定:
  input_variables:
    - stringified_data (from Template Node)
  prompt: |
    以下のデータを処理してください：
    {{stringified_data}}
```

## 技術的分析ポイント

### 重点調査項目
1. **変数定義・設定の詳細確認**
   - コードノード: `return {"variable_name": value}` の形式確認
   - LLMノード: 変数参照 `{{variable_name}}` の設定確認
   - データ型の一致性（string, object, array等）

2. **ワークフロー実行ログの分析**
   - 変数の生成・消失タイミング
   - エラー・警告メッセージの詳細
   - ノード間データ転送の成否

3. **Dify固有の制約・仕様調査**
   - 変数名の制限・予約語
   - データサイズ・複雑さの制限
   - ノード間データ転送の仕様

### 解決パターン候補
1. **変数の明示的型変換**
   ```python
   # コードノード内での確実な変数出力
   return {
       "output_variable": str(processed_data),
       "_type": "string"
   }
   ```

2. **中間ノードによるバッファリング**
   ```
   Code Node → Intermediate Node → LLM Node
   中間ノードで変数の存在・型を検証
   ```

3. **条件分岐による安定化**
   ```
   変数の存在確認 → OK時はLLM実行 → NG時は再試行
   ```

## 期待される改善効果

### 安定性の向上
- **変数受け渡しの確実性**: 100%の成功率を目標
- **処理の予測可能性**: 安定した動作による信頼性向上
- **エラー処理**: 適切な例外処理による堅牢性

### 運用効率化
- **手動介入の削減**: 自動処理の信頼性向上
- **デバッグ効率**: 問題発生時の原因特定迅速化
- **保守性**: 変数管理の標準化・体系化

### 開発生産性
- **再利用性**: 安定したパターンの他ワークフローへの応用
- **拡張性**: 複雑なデータ処理への対応力向上
- **品質保証**: 変数受け渡しの品質標準化

## 実装優先度と次のアクション

### 緊急対応（即座実行）
- [ ] スクリーンショット・YAMLファイルの詳細分析
- [ ] 問題の再現手順・条件の特定
- [ ] 暫定回避策の検討・実装

### 高優先（3日以内）
- [ ] 根本原因の特定・解析
- [ ] 安定的な変数受け渡し方式の設計・実装
- [ ] テスト・検証による動作確認

### 中優先（1週間以内）
- [ ] 他ワークフローへの影響調査・対策
- [ ] 変数受け渡しのベストプラクティス確立
- [ ] 監視・アラート機能の実装

## デバッグ・診断方法

### 推奨デバッグアプローチ
1. **ログ出力の追加**
   ```python
   # コードノード内でのデバッグ出力
   print(f"Output variable: {variable_value}")
   print(f"Variable type: {type(variable_value)}")
   return {"debug_output": variable_value}
   ```

2. **段階的な検証**
   - 単純な文字列変数での動作確認
   - 複雑なオブジェクトでの段階的テスト
   - エラー条件での動作検証

この問題の解決により、Difyワークフローの変数受け渡しが安定化し、My Bestの自動処理業務の信頼性が大幅に向上することが期待されます。

## 再発防止・運用メモ
- 新規ワークフロー作成時は変数受け渡しのテストを必須とする
- 変数名は命名規則に従い、予約語を避ける
- 複雑なデータ構造の場合は中間検証ステップを設ける