---
file_type: "ticket_summary"
ticket_id: "TKT-20250803-004"
title: "ECサイト商品順位がすべてAmazonとして認識される問題"
company: "My Best"
reporter: "My Best（チーム）"
create_date: "2025-08-03"
update_date: "2025-08-03"
status: "解決済"
final_resolution_date: "2025-08-03"
customer_confirmation: "対応完了確認済み"
category: "バグ報告"
priority: "高"
assigned_to: "技術チーム"
estimated_hours: 3
resolution_date: "2025-08-03"
related_systems: ["Dify", "Amazon", "EC順位取得システム"]
issued_at: "2025-08-03"
due_date: ""
ball_holder: "クローズ"
---

# チケット: EC商品順位取得の誤認識問題

## 基本情報
- **チケットID**: TKT-20250803-004
- **タイトル**: ECサイト商品順位がすべてAmazonとして認識される問題
- **会社名**: My Best
- **作成日**: 2025-08-03
- **ステータス**: 解決済
- **優先度**: 高

## 問題詳細

### 概要
ECから商品と順位を取得するDifyフローにおいて、分割後に再統合した結果、すべての商品順位がAmazonの順位として認識されてしまう問題が発生。

### 経緯
1. 定例会議で議論された内容に基づき実装
2. フローを分割したが、かえって複雑化
3. 一つに戻して修正を試みた
4. 結果：すべてがAmazonの順位として認識される

### テストケース
**入力値:**
```json
{
  "target_keyword": "XP-PENの液タブ",
  "target_audience_initial": "液晶画面に直接ペンを使ってイラストやまんがを描き、データ化できるタブレット。中国のHANVON UGEEグループの傘下にある「XP-Pen」ブランドの商品に限る。",
  "reference_constraints": null,
  "debug_mode": null,
  "composition_data": null,
  "sys.files": [],
  "sys.user_id": "dddbaae5-fba1-43d9-a9f4-95d73d327941",
  "sys.app_id": "dbe1ea48-bafa-4858-af8b-3e5c3385ee54",
  "sys.workflow_id": "235f7288-78aa-4c65-8a27-88b01c784d18",
  "sys.workflow_run_id": "4ee3c34e-c219-404f-828d-1f5d38c64049"
}
```

## 問題の詳細分析

### 予想される原因
1. **ECサイト識別ロジックの不具合**
   - 各ECサイトを区別するフラグやパラメータが失われている
   - 統合時にECサイト情報が上書きされている

2. **データマージ処理の問題**
   - 複数ECサイトのデータを統合する際の処理エラー
   - 順位情報のマッピングが正しく行われていない

3. **変数スコープの問題**
   - ECサイト識別変数が適切に伝播していない
   - ループ処理内での変数の上書き

## 調査項目

### 即時確認事項
- [ ] 各ECサイトの識別子がどこで設定されているか
- [ ] データ統合処理のロジック確認
- [ ] 変数の受け渡しフローの検証
- [ ] ループ処理内での変数スコープ

### デバッグ手順
- [ ] 各ECサイト処理の出力を個別に確認
- [ ] 統合前後のデータ構造の比較
- [ ] ECサイト識別情報の伝播経路追跡

## 期待される解決策

## 原因
全ての抽出ノードのプロンプトに同一の `"source": "amazon"` が設定されており、ECサイト識別子が上書きされて全結果がAmazonとして扱われていた。

### 短期対策
1. ECサイト識別子を明示的に保持する
2. データ統合時にECサイト情報を保護する
3. 各商品に対してECサイト情報を付与する

### 実装提案
- 各商品オブジェクトにECサイト識別フィールドを追加
- データマージ時にECサイト情報を保持
- 出力時にECサイト別に分類して表示

## 解決策

### 原因判明（2025-08-03）
全ての「〜〜〜抽出」ノードのプロンプトで、すべて同じ `"source": "amazon"` が設定されていることが原因。

### 修正方法
各ECサイトの抽出ノードで、それぞれ対応するソース名に変更：
- Amazon抽出: `"source": "amazon"`
- 楽天抽出: `"source": "rakuten"`
- Yahoo抽出: `"source": "yahoo"`
- 価格コム抽出: `"source": "kakaku"`

詳細は `solution_provided.md` を参照。

## 顧客からの確認

### Kaho Nagaso (2025-08-03 13:56)
「ありがとうございます！いただいていた内容で修正したら上記の件は対応完了したのですが」

→ **解決確認済み**

## 備考
- 「順位なし」という状態にはならないとのこと
- 分割→統合の過程で問題が発生
- 定例会議での議論内容を踏まえた実装
- コピー＆ペーストによる設定ミスが原因

## 原因（判明している範囲／仮説）
全ての抽出ノードのプロンプトに同一の `"source": "amazon"` が設定されていたため、各ECサイトの識別子が上書きされ、すべてAmazonとして認識されていた。

## 解決方法（実施手順・設定値）
各ECサイトの抽出ノードでソース名を個別に設定し直す。
- Amazon抽出: `"source": "amazon"`
- 楽天抽出: `"source": "rakuten"`
- Yahoo抽出: `"source": "yahoo"`
- 価格コム抽出: `"source": "kakaku"`

## 再発防止・運用メモ
※必要に応じて追記
