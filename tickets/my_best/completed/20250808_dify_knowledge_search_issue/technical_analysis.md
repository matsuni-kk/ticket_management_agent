---
file_type: "technical_analysis"
ticket_id: "TKT-20250808-001"
analyst: "matsuni"
analysis_date: "2025-08-08"
complexity: "中"
tech_category: "検索/ベクトル・フルテキスト"
issued_at: "2025-08-08"
due_date: ""
ball_holder: "クローズ"
---

# 技術分析: Dify ナレッジ検索チューニング

本件は「短文（単語）リスト中心のナレッジ」に対して、ベクトル/全文検索のヒット精度が不安定になっている事象。以下、原因仮説と対処方針を整理。

## 1. 迅速な切り分けチェック
- スコア閾値: 一旦「閾値オフ」または最小に設定し、`top_k` を十分大きく（例: 50〜200）してヒット母数を確保。
- 検索モード: ベクトル/全文/ハイブリッドを切替試験し、どこでヒットが消えるか確認。
- Rerank: いったんオフで「候補が取れているか」を先に確認（再現あるため既実施）。

## 2. 埋め込みの整合性（最優先）
- 埋め込みモデル混在の可能性: 途中でモデルを変更した場合、古いベクトルと混在し検索品質が崩れることがある。
- 対処: ナレッジ設定で一度 Embedding モデルを別の日本語に強いモデルへ切替→元に戻して「全量再埋め込み」を実行（全チャンクの再ベクトル化）。
- ポイント: 再埋め込み後にインデックスが更新されるまでのラグを考慮し、完了を待ってから評価。

## 3. 日本語最適化（短文・単語中心データの特性）
- ベクトル検索の限界: 単語だけの短文は語義が薄く、類似度が安定しづらい。全文/ハイブリッドの寄与が大きい。
- 全文側の調整:
  - N-gram/BM25 の挙動: 日本語は形態素解析か N-gram でのトークナイズ。N-gram の `min_gram` が大きいと短語が拾いにくくなる。
  - 可能なら N-gram 長の見直し、ストップワード設定の確認。
- 正規化の徹底:
  - 大文字小文字、全角半角、ひらがな/カタカナ、長音、記号・スペースの統一。
  - GAS 側のアップロード前処理で正規化版フィールドをメタデータとして併記（例: `keyword_raw`, `keyword_norm`）。
- 同義語・ゆらぎ対策:
  - ドメイン同義語辞書をメタデータに保持（例: 代表語ベースの `canonical_keyword`）。
  - よくある表記揺れ（全角/半角・ハイフン/スペース有無等）を列で持つ。

## 4. Dify 設定観点の推奨（一般）
- 検索タイプ: ハイブリッドを基本とし、全文の寄与を高める（短文主体のため）。
- `top_k`: 初期評価は大きめ（50〜200）。安定後に最適化。
- スコア閾値: 切り詰めすぎない。再埋め込み前後で相対的に再調整。
- Rerank: 候補が十分に取れている前提でオンにする。候補枯渇時はオフで原因切り分け。
- 埋め込みモデル: 日本語に強いモデルを選択（運用プランで選択可用な範囲で）。

## 5. データ更新フローの健全性
- 3000件/日アップロード時:
  - 追記/更新ポリシーが明確か（重複、上書き、削除）。
  - 変更検知と再埋め込みの完了待機を確保。
  - 一時的に検索が不完全になるタイムウィンドウがないか監視。
- データ品質:
  - 重複行の除去、空白や特殊記号のみの行のフィルタ。
  - 同じ語のバリエーションを正規化列にまとめる。

## 6. 最小再現セットでのABテスト
- 代表KW 50〜200件を抽出し、専用ナレッジ（テスト用）を作成。
- 設定を変えつつ、ヒット率/上位精度を比較（ベクトル/全文/ハイブリッド、`top_k`、閾値、Rerank 有無）。
- 再埋め込み有無での差異を明確化。

## 7. 追加で確認したい情報（依頼）
- 現行のナレッジ設定スクリーンショット（検索タイプ、`top_k`、閾値、Rerank、チャンク設定）。
- 埋め込みモデルの種類・変更履歴。
- 問題が再現する具体的 KW のサンプル（5〜10件）。
- アップロード処理（GAS）の前処理内容（正規化、重複排除）。

## 8. 暫定ワークアラウンド
- 急ぎでの検索: 全文単独＋閾値オフ＋`top_k`高めでの運用。
- キャンペーン/重要KW群は専用ナレッジに分離し、再埋め込み直後の鮮度で検索する。

## 9. 次のステップ（提案）
1) 埋め込みモデル切替→戻しで全量再埋め込み。
2) テスト用ナレッジで設定AB（ハイブリッド、閾値、`top_k`、Rerank）。
3) 正規化/同義語カラムのGAS実装案を用意。
4) 本番へ段階反映し、モニタリング。

---

## 進捗・追加仮説（2025-08-08）

### 観測
- 閾値オフ・ハイブリッドでも「ヒットはするが精度が低い」または「ヒットなし」のケースあり。
- Embeddingモデルを切替→戻しで全量再埋め込み後、一部クエリ（例: キッチンバサミ）は改善。
- 一方で「空気清浄機」等、完全一致チャンクが存在してもnullになるケースが継続。

### 追加仮説
1) インデックス不整合/エラー
   - ベクトル化は成功しても、インデックス側で該当ドキュメント（チャンク）が参照不能になっている可能性。
   - 更新ワークフロー中の部分的失敗により、一部のみインデックスエラーが発生している可能性。

2) 複数ベクトルDB/インデックスの混在
   - 同一ナレッジに見えて実体が分かれているか、別インデックスに分散している可能性。

### 推奨診断と対処
1) インデックス状態の可視化
   - Difyナレッジ管理画面/ログでインデックスジョブの成功・失敗件数、エラー詳細を確認。
   - 問題KW（例: 空気清浄機）のチャンクID/ドキュメントIDを取得し、インデックスに存在するか点検。

2) 再構築（Rebuild）試験
   - 対象ナレッジ単位でインデックス再構築を実施（小規模セットで先行）。
   - 再構築後にベクトル/全文/ハイブリッドの各モードでABテスト。

3) ベクトルDB統一の確認
   - 同一ベクトルDB・同一ドキュメントで事象が再現しているか確認。別DBに跨る場合は各々で再埋め込み+再構築が必要。

4) 前処理強化（継続）
   - 正規化（全半/大小/カナ/記号/空白）と代表語/同義語の併記を継続。
